<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="UTF-8">
        <title>Chat with Bot</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    </head>
    <body>
        <div class="main-container">
            <!-- Sidebar with MetaData and Document Upload -->
            <div class="sidebar">
                <!-- Document Upload Section -->
                <div class="document-upload-section">
                    <div class="upload-header">
                        üìÅ Document Manager
                    </div>
                    <div class="upload-content">
                        <!-- Upload Area -->
                        <div class="upload-area" id="uploadArea">
                            <div>üìÑ Drag & drop files here</div>
                            <div style="margin: 8px 0;">or</div>
                            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                Choose Files
                            </button>
                            <input type="file" id="fileInput" multiple 
                                   accept=".txt,.pdf,.doc,.docx,.html,.css,.js,.json,.xml,.csv,.xlsx,.ppt,.pptx">
                            <div style="font-size: 12px; color: #6c757d; margin-top: 8px;">
                                Max 10MB per file
                            </div>
                        </div>

                        <!-- Status Messages Container -->
                        <div id="statusContainer"></div>

                        <!-- Documents List -->
                        <div class="documents-list">
                            <h4 style="margin-bottom: 10px; font-size: 14px; color: #495057;">üìã Uploaded Documents</h4>
                            <div id="documentsList">
                                <div class="no-documents">
                                    No documents uploaded yet
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
            </div>

            <!-- Chat Section -->
            <div class="chat-section">
                <div class="chat-container">
                    <div class="chat-header">
                        Chat with New Bot
                    </div>
                    <div class="chat-box" id="chat-box"></div>
                    <!-- Loader shown while waiting for bot -->
                    <div id="loader" class="loader"></div>
                    <div class="chat-input">
                        <input type="text" id="user-input" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            <!-- MetaData Container -->
            <div class="metadata-comtainer" id="metadata_comtainer">
                <div class="chat-header">
                    MetaData
                </div>
                <div class="metadata"></div>
            </div>
        </div>

        <script>
            // Global variables for document management
            let documents = [];

            // Initialize when page loads
            $(document).ready(function() {
                loadDocuments();
                setupDocumentUpload();
            });

            function setupDocumentUpload() {
                // File input change event
                $('#fileInput').on('change', function(e) {
                    handleFileSelect(e.target.files);
                });
                
                // Drag and drop events
                const uploadArea = $('#uploadArea');
                
                uploadArea.on('dragover', function(e) {
                    e.preventDefault();
                    $(this).addClass('dragover');
                });
                
                uploadArea.on('dragleave', function(e) {
                    e.preventDefault();
                    $(this).removeClass('dragover');
                });
                
                uploadArea.on('drop', function(e) {
                    e.preventDefault();
                    $(this).removeClass('dragover');
                    const files = e.originalEvent.dataTransfer.files;
                    handleFileSelect(files);
                });
            }

            function handleFileSelect(files) {
                if (files.length > 0) {
                    uploadFiles(files);
                }
            }

            function uploadFiles(files) {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('documents', file);
                }

                showStatus('Uploading files...', 'info');

                $.ajax({
                    url: '/documents/upload/',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function(data) {
                        if (data.success) {
                            showStatus(`Successfully uploaded ${data.total_uploaded} files`, 'success');
                            if (data.errors.length > 0) {
                                showStatus(`Errors: ${data.errors.join(', ')}`, 'error');
                            }
                            loadDocuments(); // Refresh the documents list
                            $('#fileInput').val(''); // Clear input
                        } else {
                            showStatus(`Upload failed: ${data.errors.join(', ')}`, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        showStatus(`Upload error: ${error}`, 'error');
                    }
                });
            }

            function loadDocuments() {
                $.ajax({
                    url: '/documents/list/',
                    type: 'GET',
                    success: function(data) {
                        if (data.success) {
                            documents = data.documents;
                            displayDocuments();
                        } else {
                            console.error('Failed to load documents');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading documents:', error);
                    }
                });
            }

            function displayDocuments() {
                const documentsList = $('#documentsList');
                
                if (documents.length === 0) {
                    documentsList.html(`
                        <div class="no-documents">
                            No documents uploaded yet
                        </div>
                    `);
                    return;
                }

                let documentsHtml = '';
                documents.forEach(doc => {
                    documentsHtml += `
                        <div class="document-item">
                            <div class="doc-info">
                                <div class="doc-name">
                                    <span class="file-type-icon ${doc.type}">${doc.type.toUpperCase()}</span>
                                    ${doc.name}
                                </div>
                                <div class="doc-meta">
                                    ${formatFileSize(doc.size)} ‚Ä¢ ${formatDate(doc.upload_date)}
                                </div>
                            </div>
                            <button class="delete-btn" onclick="deleteDocument('${doc.id}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                });
                
                documentsList.html(documentsHtml);
            }

            function deleteDocument(documentId) {
                if (!confirm('Are you sure you want to delete this document?')) {
                    return;
                }

                $.ajax({
                    url: '/documents/delete/',
                    type: 'POST',
                    data: {
                        'document_id': documentId,
                        'csrfmiddlewaretoken': getCookie('csrftoken')
                    },
                    success: function(data) {
                        if (data.success) {
                            showStatus(data.message, 'success');
                            loadDocuments(); // Refresh the documents list
                        } else {
                            showStatus(`Delete failed: ${data.error}`, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        showStatus(`Delete error: ${error}`, 'error');
                    }
                });
            }

            function showStatus(message, type) {
                const statusContainer = $('#statusContainer');
                const statusDiv = $(`<div class="status-message status-${type}">${message}</div>`);
                
                statusContainer.append(statusDiv);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    statusDiv.fadeOut(() => statusDiv.remove());
                }, 5000);
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Original sendMessage function (preserved and enhanced)
            function sendMessage() {
                const userInput = $('#user-input').val().trim();
                //if (!userInput) return;

                $('#chat-box').append('<div class="message user">You: ' + userInput + '</div>');
                $('#user-input').val('');
                $('#loader').show();

                $.post('/chat-input/', { message: userInput }, function(data) {
                    let originalText = data.response;
                    let formattedText = originalText.replace(/\n/g, "<br/>");
                    $('#chat-box').append('<div class="message bot">Bot: ' + formattedText + '</div>');
                    
                    // Enhanced metadata display
                    let metadataHtml = `
                        <p>Response Type: ${data.response_meta.response_type}</p>
                        <p>Source: ${data.response_meta.source}</p>
                        <p>Total Tokens: ${data.response_meta.total_tokens}</p>
                        <p>Input Tokens: ${data.response_meta.input_tokens}</p>
                        <p>Output Tokens: ${data.response_meta.output_tokens}</p>
                    `;
                    
                    // Add document-related metadata if available
                    if (data.response_meta.available_documents !== undefined) {
                        metadataHtml += `<p>Available Documents: ${data.response_meta.available_documents}</p>`;
                    }
                    
                    
                    $('.metadata').html(metadataHtml);

                }).fail(function(jqXHR, textStatus, errorThrown) {
                    $('#chat-box').append('<div class="message bot">‚ùå Error: ' + errorThrown + '</div>');
                }).always(function() {
                    $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    $('#loader').hide();
                });
            }
        </script>
    </body>
</html>